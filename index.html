<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Localise-moi</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    .top-bar {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .top-bar input {
      margin-bottom: 5px;
      display: block;
      width: 100%;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <input id="me" placeholder="Je suis (ex: alexandra)" />
    <input id="follow" placeholder="Je veux suivre (ex: malo,papy)" />
    <button onclick="startApp()">Lancer</button>
    <button onclick="copyLink()">üìé Copier mon lien</button>
    <button onclick="stopSharing()">üõë Arr√™ter le partage</button>
  </div>
  <div id="map"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA4hj_DmjGGcSzhrx1FsBTns1HQP3LOn3c",
      authDomain: "geoloc-51e21.firebaseapp.com",
      databaseURL: "https://geoloc-51e21-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "geoloc-51e21",
      storageBucket: "geoloc-51e21.appspot.com",
      messagingSenderId: "948392080696",
      appId: "1:948392080696:web:e3efa86d81c28cd2f3dfcd"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const map = L.map('map').setView([48.8566, 2.3522], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data ¬© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'
    }).addTo(map);

    const markers = {};
    let watchId = null;

    function updateMarker(username, lat, lng) {
      if (markers[username]) {
        markers[username].setLatLng([lat, lng]);
      } else {
        markers[username] = L.marker([lat, lng]).addTo(map).bindPopup(username);
      }
    }

    function startApp() {
      const me = getMe();
      const follow = getFollow();
      if (!me) return alert("Tu dois indiquer ton pr√©nom !");

      // Partage en continu
      watchId = navigator.geolocation.watchPosition(position => {
        const { latitude, longitude } = position.coords;
        db.ref('users/' + me).set({
          lat: latitude,
          lng: longitude,
          timestamp: Date.now()
        });
      }, err => alert("Erreur GPS : " + err.message), {
        enableHighAccuracy: true,
        maximumAge: 10000,
        timeout: 10000
      });

      // Suivre les autres
      follow.forEach(user => {
        db.ref('users/' + user).on('value', snapshot => {
          const data = snapshot.val();
          if (data) {
            updateMarker(user, data.lat, data.lng);
          }
        });
      });
    }

    function stopSharing() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        alert("Partage arr√™t√©.");
      }
    }

    function copyLink() {
      const me = getMe();
      const follow = getFollow();
      if (!me) return alert("Renseigne ton pr√©nom d'abord !");
      const link = `${window.location.origin}?me=${me}&follow=${follow.join(',')}`;
      navigator.clipboard.writeText(link).then(() => {
        alert("Lien copi√© dans le presse-papiers ! Envoie-le √† tes proches ‚úâÔ∏è");
      });
    }

    function getMe() {
      return document.getElementById('me').value.trim().toLowerCase();
    }

    function getFollow() {
      const raw = document.getElementById('follow').value.trim().toLowerCase();
      return raw ? raw.split(',') : [];
    }

    function prefillFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const me = params.get('me');
      const follow = params.get('follow');
      if (me) document.getElementById('me').value = me;
      if (follow) document.getElementById('follow').value = follow;
    }

    prefillFromUrl();
  </script>
</body>
</html>
