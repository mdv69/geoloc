<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Localise-moi</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    .top-bar {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      width: 220px;
    }
    .top-bar input {
      margin-bottom: 5px;
      display: block;
      width: 100%;
    }
    .follower-list {
      margin-top: 10px;
    }
    .follower-item {
      cursor: pointer;
      padding: 5px;
      border-bottom: 1px solid #ccc;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .follower-item img {
      width: 24px;
      height: 24px;
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <input id="me" placeholder="Je suis (ex: alexandra)" />
    <input id="follow" placeholder="Je veux suivre (ex: malo,papy)" />
    <input type="file" id="photoUpload" accept="image/*" />
    <button onclick="startApp()">Lancer</button>
    <button onclick="copyLink()">📎 Copier mon lien</button>
    <button onclick="stopSharing()">🛑 Arrêter le partage</button>
    <div class="follower-list" id="followerList"></div>
  </div>
  <div id="map"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA4hj_DmjGGcSzhrx1FsBTns1HQP3LOn3c",
      authDomain: "geoloc-51e21.firebaseapp.com",
      databaseURL: "https://geoloc-51e21-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "geoloc-51e21",
      storageBucket: "geoloc-51e21.appspot.com",
      messagingSenderId: "948392080696",
      appId: "1:948392080696:web:e3efa86d81c28cd2f3dfcd"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    const map = L.map('map').setView([48.8566, 2.3522], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'
    }).addTo(map);

    const markers = {};
    let watchId = null;
    const userPhotos = {};

    function getAvatarUrl(username) {
      return userPhotos[username] || `https://ui-avatars.com/api/?name=${username}&background=random&size=64`;
    }

    function updateMarker(username, lat, lng) {
      const avatarUrl = getAvatarUrl(username);
      const icon = L.icon({
        iconUrl: avatarUrl,
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40]
      });

      if (markers[username]) {
        markers[username].setLatLng([lat, lng]);
      } else {
        markers[username] = L.marker([lat, lng], { icon }).addTo(map).bindPopup(username);
        addFollowerToList(username);
      }
    }

    function addFollowerToList(username) {
      const list = document.getElementById('followerList');
      if (document.getElementById('follower-' + username)) return;
      const item = document.createElement('div');
      item.className = 'follower-item';
      item.id = 'follower-' + username;

      const avatar = document.createElement('img');
      avatar.src = getAvatarUrl(username);
      avatar.alt = username;

      const label = document.createElement('span');
      label.textContent = username;

      item.appendChild(avatar);
      item.appendChild(label);

      item.onclick = () => {
        const marker = markers[username];
        if (marker) {
          map.setView(marker.getLatLng(), 15);
          marker.openPopup();
        }
      };
      list.appendChild(item);
    }

    function uploadPhotoIfExists(username) {
      const file = document.getElementById('photoUpload').files[0];
      if (!file) return;
      const ref = storage.ref('photos/' + username);
      return ref.put(file).then(() => ref.getDownloadURL()).then(url => {
        db.ref('users/' + username + '/photo').set(url);
        userPhotos[username] = url;
      });
    }

    function startApp() {
      const me = getMe();
      const follow = getFollow();
      if (!me) return alert("Tu dois indiquer ton prénom !");

      localStorage.setItem('me', me);
      localStorage.setItem('follow', follow.join(','));

      addFollowerToList(me); // ajoute juste le nom dans la liste, sans afficher de point sur la map


      uploadPhotoIfExists(me).finally(() => {
        watchId = navigator.geolocation.watchPosition(position => {
          const { latitude, longitude } = position.coords;
          db.ref('users/' + me).update({
            lat: latitude,
            lng: longitude,
            timestamp: Date.now()
          });
          updateMarker(me, latitude, longitude);
        }, err => alert("Erreur GPS : " + err.message), {
          enableHighAccuracy: true,
          maximumAge: 10000,
          timeout: 10000
        });
      });

      [...follow, me].forEach(user => {
        db.ref('users/' + user).on('value', snapshot => {
          const data = snapshot.val();
          if (data) {
            if (data.photo) userPhotos[user] = data.photo;
            updateMarker(user, data.lat, data.lng);
          }
        });
      });
    }

    function stopSharing() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        alert("Partage arrêté.");
      }
    }

    function copyLink() {
      const me = getMe();
      const follow = getFollow();
      if (!me) return alert("Renseigne ton prénom d'abord !");
      const link = `${window.location.origin}?me=${me}&follow=${follow.join(',')}`;
      navigator.clipboard.writeText(link).then(() => {
        alert("Lien copié dans le presse-papiers ! Envoie-le à tes proches ✉️");
      });
    }

    function getMe() {
      return document.getElementById('me').value.trim().toLowerCase();
    }

    function getFollow() {
      const raw = document.getElementById('follow').value.trim().toLowerCase();
      return raw ? raw.split(',') : [];
    }

    function prefillFromLocalStorage() {
      const me = localStorage.getItem('me');
      const follow = localStorage.getItem('follow');
      if (me) document.getElementById('me').value = me;
      if (follow) document.getElementById('follow').value = follow;
    }

    window.onload = () => {
      prefillFromLocalStorage();
      setTimeout(() => document.querySelector('button[onclick="startApp()"]').click(), 500);
    }
  </script>
</body>
</html>
